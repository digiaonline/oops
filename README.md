# nordsoftware-ops

**_Everything here is subject to change_**

This repository holds everything related to infrastructure/operations for all our projects. In a nutshell, we use 
Packer to build Vagrant boxes from a standard Ubuntu Server (or any other image if necessary) image. Packer then uses 
local Ansible provisioning to provision the software required in the box. The built boxes can then be uploaded to 
Atlas which makes them available to Vagrant. See ["The provisioning process"](#the-provisioning-process) for more details.

## Guidelines

The master branch of this repository serves as an example of how everything fits together. The master branch should 
always be generic, i.e. you must assume that the boxes generated by it will be publicly available to anyone using 
Vagrant.

## Requirements

If you only want to build Vagrant boxes you don't need Terraform.

### Packer

* Make sure you have [Packer](https://packer.io/) installed
* Make an account on Atlas if you haven't done so already, then ask someone to add you to the `nordsoftware` 
organization. Once you've done that, create an Atlas token by clicking your nickname in the menu bar, then Tokens. Add 
this token as an environment variable named `ATLAS_TOKEN`. Consult the Internet on how to do this for your operating 
system.

### Terraform

* Make sure you have [Terraform](https://terraform.io/) installed

## Usage

### Packer

These instructions are only for simply building a base box from the master branch. If you're on a project-specific 
branch you should probably check that branch's README.md instead.

* Enter the `packer/` directory. The paths in the Packer template are relative to the directory `packer` is run from 
so this step is important.
* Run `packer validate nginx-php-mariadb-nodejs.json` to verify that the configuration is valid
* Run `packer build nginx-php-mariadb-nodejs.json` to build the Vagrant box locally and push it to 
Atlas, or run `packer push nginx-php-mariadb-nodejs.json` to build the box in Atlas instead. The latter is the 
preferred way of doing it.

If your Packer template is configured to push any production artifacts to Atlas (such as Amazon AMIs) you can browse to 
the artifact to get a code snippet for use by Terraform (see the next chapter).

The master branch ships with a few base boxes that can be used as baselines when creating project-specific boxes:

* `nginx-php-mariadb-nodejs` a basic stack
* `nginx-php` not very useful
* `ubuntu-1510-nginx-php-mariadb-nodejs` same as the first box, but based on Ubuntu 15.10 instead of 14.04.

### Terraform

* When you've created a new project and you have an initial `.tf` file for project's infrastructure you should 
configure remote state. This means the current infrastructure state is pushed to Atlas, after which you can use 
`terraform push` to update the state.
* Configure the project to use remote state by running `terraform remote config -backend-config="name=nordsoftware/project-name"`. 
You will be asked to enter any undefined variable values (such as secret API keys). These will then be pushed to Atlas 
as well so other team members won't have to bother knowing them generally.
* Once remote state has been configured, run `terraform push` to trigger a new "change". Now you can head over to Atlas 
and confirm the new changes.

### Customized environment for a project

In many cases the base box available in the master branch won't be sufficient for a particular project. Instead of 
adding your own various provisioning hacks, use the following instructions to generate a suitable box.

* Create a new branch in this repository with the same name as your project's repository
* Rename the base box you want to use as a starting point to something that corresponds with your project. Also 
rename the Ansible playbook file. This is not strictly a requirement but it helps keep ambiguity in check.
* Change whatever you need to get your box into shape, then follow the steps under ["Usage"](#usage) to build the box and push 
 it to Atlas.
* Add this repository as a submodule in your own project's repository and make it point to the branch you just created. 
In general the module is named `ops`.
 
### Adapting an environment to new requirements

Sooner or later after an environment is created the requirements change slightly so you need to adapt the environment. 
If that's the case, simply change whatever you have to in the provisioning process, then push a new build to Atlas 
using `packer push`.

Once the necessary changes have been made there are two ways to bring existing environments up to speed:

* Run `vagrant box update`, then `vagrant destroy` and then `vagrant up`
* Update your project's `ops` submodule and run `vagrant provision`. This assumes you've configured your Vagrantfile to 
run the same provisioning as Packer does during the build process. This approach is faster and doesn't require you to 
destroy your existing environment.
 
### Notes about Atlas

Boxes pushed to Atlas are private by default, meaning strangers on the Internet won't be able to see that you have a 
box named `nordsoftware/secret-project`. To use private boxes in Vagrant you will have to either a) create an Atlas 
token and add it as an environment variable or b) create an Atlas account and run `vagrant login` before you run 
`vagrant up` for the first time.

If you want to create a new base box which is supposed to be public, log in to Atlas, find the Vagrant box, select 
Settings and untick the "Private" checkbox.

## The provisioning process

When a box is created and provisioned Packer starts with a standard Linux distribution image. It then uses shell 
provisioners to do the bare minimum required to get Ansible installed and working properly. This includes things like 
installing the VirtualBox guest additions, configuring sudo and so on.
 
The real provisioning is done by Ansible, and unless you have a very good reason not to you should adapt your Ansible 
playbook(s) instead of provisioning directly from Packer. See [ansible/README.md](packer/ansible/README.md) for further 
details.
